<a id="ophom_plugsettings" class="pull-right" title="On/Off Printer" style="cursor: pointer;">
	<font id="ophom_plugbutton" color='grey'>
	<i class="fa fa-plug"></i>
	</font>
</a>

<script>
	var plug_button = document.getElementById("ophom_plugbutton");

	// Vérification du statut actuel de la configuration de Ophom
	fetch(API_BASEURL + "plugin/ophom?action=isconfigured").then(function(response) {
		response.json().then(function(data) {
			if(data.reponse != 2)
			{
				plug_button.style.color = "grey"
				plug_button.addEventListener('click', function(){
					alert("Ophom is not configured !\nPlease open settings and go in the \"Plugins -> Ophom\" section.");
				})
			}
			else
			{	
				// Récupération du statut au lancement de la page
				checkPlugStatus();

				// Boucle de vérification du statut de la prise
				var check_plug_status = setInterval(function() {
					checkPlugStatus();
				},5000)

				// Envoi de la commande toggle pour allumer ou éteindre la prise
				document.getElementById("ophom_plugsettings").addEventListener('click', function(){

					fetch("/api/printer").then(function(response){
						response.json().then(function(data) {
							if(data.state.text == "Printing")
							{
								if(confirm("A print is currently running !\nDo you really want turn off the plug ?"))
								{
									toggle();
								}
							}
							else
							{
								toggle();
							}
						})
					})

					
				})
			}
		})
	});

	function checkPlugStatus()
	{
		fetch(API_BASEURL + "plugin/ophom?action=checkplugstatus").then(function(response) {
			response.json().then(function(data) {
				if(data.reponse == 1)
				{
					plug_button.style.color = '#06c700';
				}
				else
				{
					plug_button.style.color = 'red';
				}
			})
		});
	}

	function toggle()
	{
		fetch(API_BASEURL + "plugin/ophom?action=toggle").then(function(response) {
			response.json().then(function(data) {
				if(data.reponse == 1)
				{
					plug_button.style.color = '#06c700';
					autoConnect();
				}
				else
				{
					plug_button.style.color = 'red';
				}
			});
		})
	}

	function autoConnect()
	{
		fetch(API_BASEURL + "settings").then(function(response) {
			response.json().then(function(data) {
				if(data.plugins.ophom.auto_connect == true)
				{
					setTimeout(function() {
						fetch(API_BASEURL + "connection", {
							method: "POST",
							body : JSON.stringify({command: "connect"}),
							headers: { 'Content-Type': 'application/json'}
						});
					}, 5000)
				}
			})
		})
	}
</script>